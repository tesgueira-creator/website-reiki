name: Sync Vercel Env (Staging)

on:
    workflow_dispatch:
        inputs:
            environment:
                description: "Vercel environment to add (preview or production)"
                required: true
                default: "preview"
    push:
        branches: [staging]

jobs:
    sync-envs:
        name: Sync secrets to Vercel (staging)
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Prepare environment
              env:
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN_STAGING }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_STAGING }}
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID_STAGING }}
              run: |
                  echo "Using project: $VERCEL_PROJECT_ID" 
                  # Mask variables in logs to be extra-safe
                  echo "SANITY_WRITE_TOKEN=***" | sed -n '1p'

            - name: Add server envs to Vercel
              env:
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN_STAGING }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_STAGING }}
                  SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
                  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
                  STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
                  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
                  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
                  STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
                  ENV_TARGET: ${{ github.event.inputs.environment }}
              run: |
                  set -euo pipefail
                  API_ENDPOINT="https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID/env"

                  add_env(){
                    local key="$1" value="$2" targets="$3"
                    cat > /tmp/payload.json << 'ENVJSON'
{
  "key": "KEY_PLACEHOLDER",
  "value": "VALUE_PLACEHOLDER",
  "type": "encrypted",
  "target": [TARGETS_PLACEHOLDER]
}
ENVJSON
                    # Replace placeholders
                    sed -i "s/KEY_PLACEHOLDER/$key/g" /tmp/payload.json
                    sed -i "s/VALUE_PLACEHOLDER/$value/g" /tmp/payload.json
                    sed -i "s/TARGETS_PLACEHOLDER/$targets/g" /tmp/payload.json

                    # Use curl to POST
                    http_status=$(curl -s -o /tmp/resp.json -w "%{http_code}" -X POST "$API_ENDPOINT?upsert=true" \
                      -H "Authorization: Bearer $VERCEL_TOKEN" \
                      -H "Content-Type: application/json" \
                      -d @/tmp/payload.json)
                    echo "Added $key -> HTTP $http_status"
                    if [ "$http_status" -ge 400 ]; then
                      echo "Response:" && cat /tmp/resp.json >&2
                      exit 1
                    fi
                  }

                  # Add server-only secrets to Preview/Production depending on ENV_TARGET
                  add_env "SANITY_WRITE_TOKEN" "$SANITY_WRITE_TOKEN" '"preview"'
                  add_env "STRIPE_SECRET_KEY" "$STRIPE_SECRET_KEY" '"preview"'
                  add_env "STRIPE_WEBHOOK_SECRET" "$STRIPE_WEBHOOK_SECRET" '"preview"'
                  add_env "RESEND_API_KEY" "$RESEND_API_KEY" '"preview"'
                  add_env "NEXTAUTH_SECRET" "$NEXTAUTH_SECRET" '"preview"'

                  # Add client-visible publishable key
                  add_env "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" "$STRIPE_PUBLISHABLE_KEY" '"preview"'

            - name: Done
              run: echo "Vercel envs synced (preview)"
