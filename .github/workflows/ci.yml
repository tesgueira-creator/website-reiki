name: CI

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]
    workflow_dispatch: {}

jobs:
    test:
        name: Test, typecheck & lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
            - name: Install
              run: npm ci
            - name: Typecheck
              run: npm run typecheck
            - name: Lint
              run: npm run lint
            - name: Run tests
              run: npm test -- --reporter=dot

    build:
        name: Build (verifica erros de runtime)
        needs: test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
            - name: Install
              run: npm ci
            - name: Build
              run: npm run build

    env-check:
        name: Verify required env secrets (main only)
        needs: build
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - name: Check required secrets are present
              env:
                  SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
                  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
                  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
                  GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
                  GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
                  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
              run: |
                  missing=0
                  for var in SANITY_WRITE_TOKEN STRIPE_SECRET_KEY RESEND_API_KEY GOOGLE_SERVICE_ACCOUNT_EMAIL GOOGLE_SERVICE_ACCOUNT_KEY NEXTAUTH_SECRET; do
                    if [ -z "${!var}" ]; then
                      echo "Missing $var"
                      missing=1
                    fi
                  done
                  if [ "$missing" -eq 1 ]; then
                    echo "One or more required secrets are missing. Failing."
                    exit 1
                  fi
